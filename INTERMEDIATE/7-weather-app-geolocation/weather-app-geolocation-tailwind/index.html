<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather Geolocation â€” Level 3 (Tailwind)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-dvh bg-gradient-to-br from-slate-900 to-indigo-950 text-slate-100">
  <header class="py-6 text-center">
    <h1 class="text-2xl font-bold">ğŸ“ Weather App â€” Tailwind</h1>
    <p class="text-slate-400">Hiá»ƒn thá»‹ tráº¡ng thÃ¡i permission + loader</p>
  </header>

  <main class="w-[min(1100px,92vw)] mx-auto pb-10">
    <section id="hero" class="rounded-2xl p-10 text-center text-5xl font-extrabold bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-800">Äang chá» vá»‹ trÃ­â€¦</section>
    <div id="status" class="text-slate-300 mt-2"></div>

    <section class="grid grid-cols-1 lg:grid-cols-[2fr,1fr] gap-4 mt-4">
      <aside class="rounded-2xl p-4 bg-slate-900/70 border border-slate-800">
        <h3 class="font-semibold">Chá»‰ sá»‘</h3>
        <div id="stats">â€”</div>
      </aside>
      <div class="rounded-2xl p-4 bg-slate-900/70 border border-slate-800">
        <h3 class="font-semibold">Dá»± bÃ¡o 5 ngÃ y</h3>
        <div id="forecast" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3"></div>
      </div>
    </section>
  </main>

  <script>
    const hero = document.getElementById('hero')
    const statusEl = document.getElementById('status')
    const stats = document.getElementById('stats')
    const forecast = document.getElementById('forecast')

    function wcToIcon(w){ const m = {0:'â˜€ï¸',1:'ğŸŒ¤ï¸',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«ï¸',48:'ğŸŒ«ï¸',51:'ğŸŒ¦ï¸',61:'ğŸŒ§ï¸',71:'â„ï¸',80:'ğŸŒ§ï¸',95:'â›ˆï¸'}; return m[w] || 'ğŸŒ¡ï¸' }

    async function reverseName(lat, lon){
      const url = new URL('https://geocoding-api.open-meteo.com/v1/reverse')
      url.search = new URLSearchParams({ latitude: lat, longitude: lon, language: 'vi' })
      const r = await fetch(url); if(!r.ok) return ''
      const d = await r.json(); return d?.results?.[0]?.name || ''
    }

    async function fetchWeather(lat, lon){
      const url = new URL('https://api.open-meteo.com/v1/forecast')
      url.search = new URLSearchParams({
        latitude: lat, longitude: lon, timezone: 'auto',
        current: 'temperature_2m,relative_humidity_2m,apparent_temperature,wind_speed_10m,weather_code',
        daily: 'temperature_2m_max,temperature_2m_min,weather_code'
      })
      const res = await fetch(url); if(!res.ok) throw new Error('Weather failed')
      return await res.json()
    }

    function render(data, name){
      const c = data.current
      hero.innerHTML = `${wcToIcon(c.weather_code)}<div class="text-6xl mt-2">${Math.round(c.temperature_2m)}Â°C</div><div class="text-xl text-slate-300 mt-2">${name||''}</div>`
      stats.innerHTML = `Äá»™ áº©m: ${c.relative_humidity_2m}%<br>GiÃ³: ${c.wind_speed_10m} m/s<br>Thá»ƒ cáº£m: ${Math.round(c.apparent_temperature)}Â°C`
      forecast.innerHTML = data.daily.time.slice(0,5).map((d,i)=>{
        const hi = Math.round(data.daily.temperature_2m_max[i]); const lo = Math.round(data.daily.temperature_2m_min[i]); const code = data.daily.weather_code[i]
        return `<div class="rounded-xl border border-slate-800 p-3 text-center">${wcToIcon(code)}<div class="text-sm">${d}</div><div class="font-semibold">${hi}Â°/${lo}Â°</div></div>`
      }).join('')
    }

    function getLocation(){
      if(!navigator.geolocation){ statusEl.textContent = 'TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ geolocation.'; return }
      statusEl.textContent = 'Äang yÃªu cáº§u quyá»n truy cáº­p vá»‹ trÃ­â€¦'
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const { latitude: lat, longitude: lon } = pos.coords
        statusEl.textContent = `VÄ© Ä‘á»™: ${lat.toFixed(4)}, Kinh Ä‘á»™: ${lon.toFixed(4)}`
        hero.textContent = 'Äang táº£i thá»i tiáº¿tâ€¦'
        try{
          const [name, data] = await Promise.all([reverseName(lat, lon), fetchWeather(lat, lon)])
          render(data, name)
        }catch(e){ hero.textContent = 'Lá»—i láº¥y dá»¯ liá»‡u thá»i tiáº¿t.' }
      }, (err)=>{
        statusEl.textContent = 'KhÃ´ng láº¥y Ä‘Æ°á»£c vá»‹ trÃ­: ' + err.message
        hero.textContent = 'Cáº§n quyá»n vá»‹ trÃ­ Ä‘á»ƒ hiá»ƒn thá»‹.'
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 })
    }
    getLocation()
  </script>
</body>
</html>
